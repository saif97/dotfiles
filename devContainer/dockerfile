# Dev Container for dotfiles
# Build: docker build --platform linux/amd64 -t dev_container -f devContainer/dockerfile .
# Run: docker run --rm -it dev_container

FROM ubuntu:25.10

ARG USERNAME=dev_in_a_box
ENV DEBIAN_FRONTEND=noninteractive
ENV USER_HOME="/home/${USERNAME}"

# Install system packages
COPY devContainer/install-packages.sh /tmp/install-packages.sh
RUN bash /tmp/install-packages.sh

# Install Node.js
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install global npm packages
RUN npm install -g typescript @google/gemini-cli

# Create user and add to sudoers (needed for entrypoint to fix volume permissions)
RUN groupadd ${USERNAME} && useradd -ms /bin/zsh -g ${USERNAME} ${USERNAME} \
    && echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Ensure user owns their entire home directory
RUN chown -R ${USERNAME}:${USERNAME} ${USER_HOME}

USER ${USERNAME}
WORKDIR ${USER_HOME}

# Copy dotfiles from local machine
COPY --chown=${USERNAME}:${USERNAME} ../ ${USER_HOME}/dotfiles

# Run install script to set up symlinks and plugins
RUN cd ${USER_HOME}/dotfiles && bash install.sh

# Copy and set up entrypoint script
COPY devContainer/entrypoint.sh /usr/local/bin/entrypoint.sh
USER root
RUN chmod +x /usr/local/bin/entrypoint.sh
USER ${USERNAME}

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["zsh"]
